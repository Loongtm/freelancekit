<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>发票 · FreelanceKit</title>

  <!-- SEO -->
  <script defer src="/assets/js/seo.js"></script>

  <!-- 样式（按你项目结构保持以下路径） -->
  <link rel="stylesheet" href="/assets/css/dashboard.css" />
  <link rel="stylesheet" href="/assets/css/print.css" />
  <link rel="stylesheet" href="/assets/css/print-preview.css" />

  <style>
    :root{
      --bg:#0a0a0a; --panel:#111; --text:#0b1220; --muted:#6b7280;
      --border:#e5e7eb; --brand:#111827; --white:#fff;
      /* 黑金主题色（可被 brand.js 动态覆盖） */
      --gold:#facc15; --gold-2:#fde68a; --black:#0a0a0a; --card:#0f0f0f; --line:rgba(250,204,21,.32);
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0b0f14;color:#111}

    /* 页面容器与工具栏 */
    .page{max-width:1024px;margin:28px auto;padding:0 16px}
    .toolbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 16px;border:1px solid #222;border-radius:14px;background:#0f1217;color:#e5e7eb
    }
    .toolbar .left{display:flex;align-items:center;gap:10px}
    .toolbar select, .toolbar button{
      border-radius:10px;border:1px solid #2a2f38;background:#0b0f14;color:#e5e7eb;
      padding:8px 12px;cursor:pointer
    }
    .toolbar button.primary{background:#facc15;color:#111;border-color:#facc15;font-weight:700}

    /* 打印纸张 */
    .sheet{background:#fff;color:#0b1220;border-radius:18px;border:1px solid #e5e7eb;margin:18px 0;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .sheet-inner{padding:40px 42px}

    /* ====== 标准（Classic）主题 ====== */
    .theme-classic .sheet{background:#fff;color:#0b1220;border-color:#e5e7eb}
    .theme-classic .meta-label{color:#6b7280}
    .theme-classic .hline{height:1px;background:#e5e7eb;margin:18px 0}

    /* ====== 黑金（Pro）主题 ====== */
    .theme-black-gold body{background:var(--black)}
    .theme-black-gold .toolbar{background:#0c0c0c;border-color:#232323;color:#d1d5db}
    .theme-black-gold .sheet{background:var(--card);color:#f8fafc;border:1px solid var(--line)}
    .theme-black-gold .meta-label{color:#d1d5db;opacity:.75}
    .theme-black-gold .hline{height:2px;background:linear-gradient(90deg,var(--gold),var(--gold-2));margin:18px 0;border-radius:2px}

    /* 发票封面（Logo 居中 + 标题） */
    .cover{display:flex;flex-direction:column;align-items:center;text-align:center;gap:8px;margin-bottom:12px}
    .cover .logo{width:88px;height:88px;object-fit:contain}
    .cover .title{font-size:28px;font-weight:800;letter-spacing:.5px}
    .theme-black-gold .cover .title{color:var(--gold)}
    .cover .subtitle{color:#6b7280;font-size:14px}
    .theme-black-gold .cover .subtitle{color:#eab308;opacity:.95}

    /* 编号 / 日期 / 截止 */
    .meta-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:10px}
    .meta-box{border:1px dashed #e5e7eb;border-radius:12px;padding:12px 14px}
    .meta-kv{display:flex;flex-direction:column;gap:4px}
    .meta-label{font-size:12px;letter-spacing:.5px;text-transform:uppercase}
    .meta-value{font-weight:700;font-size:16px;word-break:break-all}
    .theme-black-gold .meta-box{border-color:var(--line);background:#0b0b0b}
    .theme-black-gold .meta-value{color:#fff}

    /* 买卖双方两栏 */
    .party-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
    .panel{border:1px solid #e5e7eb;border-radius:12px;padding:14px}
    .panel h4{margin:0 0 6px 0;font-size:14px;color:#374151}
    .theme-black-gold .panel{border-color:var(--line);background:#0b0b0b}
    .theme-black-gold .panel h4{color:var(--gold)}

    /* 项目明细表格 */
    table.items{width:100%;border-collapse:collapse;margin-top:14px}
    table.items th, table.items td{padding:10px 12px;border-bottom:1px solid #e5e7eb;text-align:left;vertical-align:top}
    table.items th{font-size:12px;letter-spacing:.5px;text-transform:uppercase;color:#6b7280}
    table.items td.num{text-align:right;white-space:nowrap}
    .theme-black-gold table.items th{color:#f4f4f5;border-color:var(--line)}
    .theme-black-gold table.items td{border-color:var(--line);color:#f8fafc}

    /* 合计 */
    .totals{display:grid;grid-template-columns:1fr auto;gap:8px;margin-top:18px}
    .totals .label{color:#6b7280}
    .totals .val{font-weight:800}
    .theme-black-gold .totals .label{color:#e5e7eb;opacity:.8}
    .theme-black-gold .totals .val{color:#fff}

    /* 付款方式与备注 */
    .notes{margin-top:16px;border:1px dashed #e5e7eb;border-radius:12px;padding:12px}
    .theme-black-gold .notes{border-color:var(--line);background:#0b0b0b;color:#e5e7eb}

    /* 页脚 */
    .foot{margin-top:18px;text-align:center;color:#6b7280;font-size:12px}
    .theme-black-gold .foot{color:#d1d5db}

    /* 打印优化 */
    @media print{
      body{background:#fff}
      .toolbar{display:none !important}
      .page{margin:0;padding:0}
      .sheet{border:none;box-shadow:none;border-radius:0}
      .sheet-inner{padding:28px}
    }
  </style>
</head>
<body>

  <div class="page">
    <!-- 工具栏 -->
    <div class="toolbar">
      <div class="left">
        <strong>发票</strong>
        <span style="opacity:.7">· 主题：</span>
        <select id="themeSelect" title="切换主题">
          <option value="classic">Classic</option>
          <option value="black-gold">Minimal Black-Gold (PRO)</option>
        </select>
      </div>
      <div class="right">
        <button id="btnPreview">预览</button>
        <button id="btnExport" class="primary">导出 PDF</button>
      </div>
    </div>

    <!-- 品牌设置（Pro 专属） -->
    <div class="panel" id="brandPanel" style="margin-top:12px;border:1px solid rgba(250,204,21,.25);border-radius:12px;padding:12px;background:#0f1217;color:#e5e7eb">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <strong style="color:#facc15">品牌设置（Pro）</strong>
        <div style="opacity:.7">Logo / 主题色 / 页脚文案</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px">
        <div>
          <label style="display:block;margin-bottom:6px;opacity:.85">上传 Logo（PNG/SVG/JPG）</label>
          <input id="brandLogo" type="file" accept="image/*" style="width:100%;background:#0b0f14;color:#e5e7eb;padding:10px;border-radius:10px;border:1px solid #2a2f38">
          <div style="font-size:12px;opacity:.6;margin-top:6px">建议透明底 PNG，展示在发票封面居中。</div>
        </div>
        <div>
          <label style="display:block;margin-bottom:6px;opacity:.85">主色（影响黑金主题金色）</label>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="brandColor" type="text" placeholder="#facc15" style="flex:1;background:#0b0f14;color:#e5e7eb;padding:10px;border-radius:10px;border:1px solid #2a2f38">
            <input id="brandColorPicker" type="color" value="#facc15" style="width:46px;height:42px;border:none;background:transparent">
          </div>
          <div style="font-size:12px;opacity:.6;margin-top:6px">可输入 6 位十六进制（如 #D4AF37）。</div>
        </div>
      </div>
      <div style="margin-top:10px">
        <label style="display:block;margin-bottom:6px;opacity:.85">页脚文案</label>
        <input id="brandFooter" type="text" placeholder="Thank you for your business" style="width:100%;background:#0b0f14;color:#e5e7eb;padding:10px;border-radius:10px;border:1px solid #2a2f38">
      </div>
      <div style="display:flex;gap:10px;margin-top:12px">
        <button id="brandSave" class="primary" style="padding:10px 14px;border-radius:10px;border:none;background:#facc15;color:#111;font-weight:700;cursor:pointer">保存并应用</button>
        <button id="brandReset" style="padding:10px 14px;border-radius:10px;border:1px solid #2a2f38;background:transparent;color:#e5e7eb;cursor:pointer">恢复默认</button>
        <div id="brandMsg" style="margin-left:8px;opacity:.8"></div>
      </div>
    </div>

    <!-- 纸张 -->
    <div id="sheetWrap" class="sheet">
      <div class="sheet-inner" id="printRoot">
        <!-- 封面 / 居中 Logo -->
        <div class="cover">
          <!-- 黑金主题默认用浅色 Logo；品牌设置后会被替换成自定义 -->
          <img id="logoImg" class="logo" src="/assets/logo.svg" alt="Logo" onerror="this.style.display='none'"/>
          <div class="title">INVOICE · 发票</div>
          <div class="subtitle" id="subtitleText">FreelanceKit — Professional Billing</div>
        </div>

        <!-- 编号/日期 三栏 -->
        <div class="meta-grid">
          <div class="meta-box"><div class="meta-kv">
            <div class="meta-label">发票编号</div>
            <div class="meta-value" id="invNo">INV-2025-0001</div>
          </div></div>
          <div class="meta-box"><div class="meta-kv">
            <div class="meta-label">开具日期</div>
            <div class="meta-value" id="issueDate">2025-11-02</div>
          </div></div>
          <div class="meta-box"><div class="meta-kv">
            <div class="meta-label">付款截止</div>
            <div class="meta-value" id="dueDate">2025-11-30</div>
          </div></div>
        </div>

        <div class="hline"></div>

        <!-- 买卖双方 -->
        <div class="party-grid">
          <div class="panel">
            <h4>卖方 / From</h4>
            <div id="sellerBlock">
              FreelanceKit Studio<br/> hello@freelancekit.dev<br/> +60 1X-XXXX XXX
            </div>
          </div>
          <div class="panel">
            <h4>买方 / Bill To</h4>
            <div id="buyerBlock">
              Client Company Sdn Bhd<br/> client@email.com<br/> +60 1X-XXXX XXX
            </div>
          </div>
        </div>

        <!-- 明细 -->
        <table class="items" id="itemsTable">
          <thead>
            <tr>
              <th style="width:50%">项目</th>
              <th style="width:15%">数量</th>
              <th style="width:15%">单价</th>
              <th style="width:20%" class="num">小计</th>
            </tr>
          </thead>
          <tbody id="itemsBody">
            <!-- 示例行（你的 app.js 可填充/覆盖） -->
            <tr>
              <td>UI/UX 设计</td>
              <td>1</td>
              <td>MYR 9,000.00</td>
              <td class="num">MYR 9,000.00</td>
            </tr>
          </tbody>
        </table>

        <!-- 合计 -->
        <div class="totals">
          <div class="label">税额</div><div class="val" id="taxVal">MYR 0.00</div>
          <div class="label">合计</div><div class="val" id="totalVal">MYR 9,000.00</div>
        </div>

        <!-- 付款方式 / 备注 -->
        <div class="notes" id="payNotes">
          <strong>付款方式：</strong> 银行转账 / 信用卡 / PayPal（若无在选项里，请备注）<br/>
          <strong>备注：</strong> 付款请注明发票编号。逾期可能产生滞纳金。
        </div>

        <div class="foot">感谢合作 · Thank you for your business</div>
      </div>
    </div>
  </div>

  <!-- Pro 前端会话工具（徽章、存 token 等） -->
  <script defer src="/assets/js/pro.js"></script>
  <!-- 白标逻辑（品牌配置） -->
  <script defer src="/assets/js/brand.js"></script>

  <!-- 主题切换 + 品牌设置应用脚本 -->
  <script>
    (function(){
      // 主题切换
      const themeSel = document.getElementById('themeSelect');
      const logoImg  = document.getElementById('logoImg');

      function applyTheme(val){
        document.body.classList.toggle('theme-black-gold', val === 'black-gold');
        document.body.classList.toggle('theme-classic', val !== 'black-gold');
        // 黑金主题默认浅色 logo（品牌自定义会覆盖）
        if (!localStorage.getItem('fk_brand') || !JSON.parse(localStorage.getItem('fk_brand')).logo) {
          logoImg.src = (val === 'black-gold') ? '/assets/logo-light.svg' : '/assets/logo.svg';
        }
        localStorage.setItem('invoice_theme', val);
      }
      const savedTheme = localStorage.getItem('invoice_theme') || 'black-gold';
      themeSel.value = savedTheme; applyTheme(savedTheme);
      themeSel.addEventListener('change', e => applyTheme(e.target.value));

      // 按钮（与 app.js 不冲突）
      document.getElementById('btnPreview')?.addEventListener('click', ()=> window.print());
      document.getElementById('btnExport')?.addEventListener('click', ()=> window.print());

      // Pro 面板显示控制
      const pro = localStorage.getItem('pro_active') === 'true';
      if (!pro) document.getElementById('brandPanel').style.display = 'none';

      // 读取现有品牌并应用到页面
      BrandKit.applyToInvoice(document);

      // 绑定品牌设置交互
      const logoInput   = document.getElementById('brandLogo');
      const colorInput  = document.getElementById('brandColor');
      const colorPicker = document.getElementById('brandColorPicker');
      const footerInput = document.getElementById('brandFooter');
      const msgEl       = document.getElementById('brandMsg');

      // 初始化输入
      const cfg = BrandKit.getConfig();
      if (cfg.color) {
        const c = cfg.color.startsWith('#') ? cfg.color : ('#' + cfg.color);
        colorInput.value = c; colorPicker.value = c;
      }
      if (cfg.footer) footerInput.value = cfg.footer;

      colorInput.addEventListener('input', ()=> {
        const v = colorInput.value.trim();
        if (/^#?[0-9a-f]{6}$/i.test(v)) colorPicker.value = v.startsWith('#') ? v : ('#' + v);
      });
      colorPicker.addEventListener('input', ()=> { colorInput.value = colorPicker.value; });

      document.getElementById('brandSave').addEventListener('click', async ()=>{
        try{
          if (logoInput.files && logoInput.files[0]) {
            await BrandKit.setLogoFile(logoInput.files[0]);
          }
          if (colorInput.value.trim()) BrandKit.setColor(colorInput.value.trim());
          BrandKit.setFooter(footerInput.value.trim());
          BrandKit.applyToInvoice(document);
          msgEl.textContent = '✅ 已保存并应用';
          setTimeout(()=>msgEl.textContent='', 1500);
        }catch(e){ msgEl.textContent = '❌ ' + (e.message || e); }
      });

      document.getElementById('brandReset').addEventListener('click', ()=>{
        localStorage.removeItem('fk_brand');
        // 恢复默认色
        document.documentElement.style.removeProperty('--gold');
        document.documentElement.style.removeProperty('--gold-2');
        // 恢复默认 logo（按主题）
        const t = localStorage.getItem('invoice_theme') || 'black-gold';
        logoImg.src = (t === 'black-gold') ? '/assets/logo-light.svg' : '/assets/logo.svg';
        // 恢复页脚
        const footEl = document.querySelector('.foot');
        if (footEl) footEl.textContent = '感谢合作 · Thank you for your business';
        // 清空输入
        logoInput.value = ''; colorInput.value = ''; footerInput.value = ''; colorPicker.value = '#facc15';
        msgEl.textContent = '↩️ 已恢复默认'; setTimeout(()=>msgEl.textContent='', 1500);
      });
    })();
  </script>
</body>
</html>
